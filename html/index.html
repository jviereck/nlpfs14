 <!DOCTYPE html>
<html>
  <head>
 	  <script src="zepto.js"></script>
    <meta charset="UTF-8">
    <title>NLP Analysis Tool</title>
  </head>
  <body>
    Navigate Articles:
    <button onclick="showPrevious()">Previous</button>
    <button onclick="showNext()">Next</button>
    <button onclick="showRandom()">Random!</button>
    <h3>Models: <span id="article"></span></h3>
    <div id="models"></div>
    <h3>Corefs</h3>
    <div id="coref"></div>
    <h3>Sentences</h3>
    <div id="sentences"></div>
<script>
  var files = [];
  var currentFileIdx = -1;
  var data = {};
  var corefs = [];
  var sentences = [];

  function emitAttr(tag, attr) {
    out = '<' + tag;
    for (key in (attr || {})) {
      out += ' ' + key + '="' + attr[key] + '"';
    }
    out += '>';
    return out;
  }

  function setHTML(id, content) {
    document.getElementById(id).innerHTML = content;
  }

  function div(str, attr) {
    return emitAttr('div', attr) + str + '</div>';
  }

  function span(str, attr) {
    return emitAttr('span', attr) + str + '</span>';
  }

  function table(str) {
    return '<table>' + str + '</table>';
  }

  function tr(str, attr) {
    return emitAttr('tr', attr) + str + '</tr>';
  }

  function td(str) {
    return '<td>' + str + '</td>';
  }

  function li(str) {
    return '<li>' + str + '</li>';
  }

  function ul(str) {
    return '<ul>' + str + '</ul>';
  }

  function strong(str) {
    return '<strong>' + str + '</strong>';
  }

  function parseCorefs(data) {
    corefs = data.coref.map(function(entries) {
      var obj = {
        representive: entries[0][1][0],
        refs: []
      }
      function addRef(subEntry) {
        obj.refs.push({
          text: subEntry[0],
          sentence: subEntry[1],
          head: subEntry[2],
          start: subEntry[3],
          end: subEntry[4]
        });
      }

      // Add the representive itself to the references.
      addRef(entries[0][1]);

      // Add the other coreferences to the references as well.
      entries.forEach(function(entry) {
        addRef(entry[0]);
      })
      return obj;
    }).sort(function(a, b) {
      return b.refs.length - a.refs.length;
    });
  }

  function parseData(data) {
    parseCorefs(data.parse);

    data.parse.sentences.forEach(function(sentence) {
      sentence.content = sentence.text.join(' ');
    })
  }



  function updateUI() {
    function mapCoref(coref, cidx) {
      var rep = coref.refs[0];
      var headWord = sentences[rep.sentence].words[rep.head];

      return tr(
        td(coref.refs.length) +
        td(strong(coref.representive)) +
        td(headWord[1].NamedEntityTag + '/' + headWord[1].PartOfSpeech + '/' + headWord[0]),
        {'data-coref': cidx}
      )
    }

    function mapSentence(sentence, sidx) {
      return li(sentence.words.map(function(word, widx) {
        return span(word[0] + ' ', {id: 'w_' + sidx + '_' + widx});
      }).join(''));
    }

    setHTML('article', files[currentFileIdx])
    setHTML('models', ul(data.models.map(li).join('')));
    setHTML('coref', table(corefs.map(mapCoref).join('')));
    setHTML('sentences', ul(sentences.map(mapSentence).join('')));

  }

  function currentFileIndexChanged() {
    $.getJSON('data/' + files[currentFileIdx], function(json) {
      data = json;
      sentences = data.parse.sentences;

      parseData(data);
      updateUI();
    });
  }

  function showPrevious() {
    currentFileIdx = Math.max(1, currentFileIdx - 1);
    currentFileIndexChanged();
  }

  function showNext() {
    currentFileIdx = Math.min(files.length - 1, currentFileIdx + 1);
    currentFileIndexChanged();
  }

  function showRandom() {
    currentFileIdx = Math.round(Math.random() * (files.length - 1));
    currentFileIndexChanged();
  }


  $.get('filelist.txt', function(data) {
    files = data.split('\n').map(function(str) {
      return str.substring(4).replace('.', '_') + '.json';
    });

    showNext();
  })

  function isPunctuation(str) {
    return ([',', '``', "''", '.'].indexOf(str) !== -1);
  }

  colorIdx = 10;

  $(document).on('click', 'tr', function(evt) {
    var self = $(this);
    var color;
    if (self.data('toggled') == true) {
      self.data('toggled', '')
      color = '';
    } else {
      self.data('toggled', 'true')
      color = 'hsl(' + (colorIdx += 55) % 360 +', 50%, 80%)'
    }

    self.attr('style', 'background: ' + color);

    var coref = corefs[self.data('coref')];
    coref.refs.forEach(function(ref) {
      var sidx = ref.sentence;
      for (var widx = ref.start; widx < ref.end; widx++) {
        document.getElementById('w_' + sidx + '_' + widx).style.background = color;
      }
    })
  })
</script>


  </body>
</html>
